<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
    <script src="https://code.jquery.com/jquery-2.1.4.js"></script>
    <script src="Scripts/jquery.signalR-2.2.0.js"></script>
    <style>
        body {
            padding: 20px;
        }

        .error {
            color: red;
        }

        .wash {
            color: #83848A;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-6">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Remote Hardware Demo</h3>
                    </div>
                    <div class="panel-body">
                        <form class="form-inline">
                            <div class="form-group">
                                <label for="user-name"></label>
                                <input type="text" class="form-control" id="user-name" placeholder="User Name">
                            </div>
                            <button type="button" class="btn btn-default" id="connect">Connect</button>
                            <div class="form-group">
                                <label for="" style="margin: 0 0 0 10px;" id="connected" class="error">You are not connected</label>
                            </div>
                        </form>
                        <form style="margin: 20px 0 0 0;">
                            <div class="form-group">
                                <label for="to">To</label>
                                <input type="email" class="form-control" style="width: 185px;" id="to" placeholder="To">
                            </div>
                            <div class="form-group">
                                <label class="form-inline" for="transactionType">Action</label>
                                <select class="form-control" id="transactionType" style="width: auto">
                                    <option value="CreditSale" selected>Credit Sale</option>
                                    <option value="Void">Void</option>
                                    <option value="RequestSignature">Request Signature</option>
                                    <option value="Echo">Echo</option>
                                </select>
                            </div>
                            <div id="CreditSale">
                                <label for="amount">Amount</label>
                                <input class="form-control" style="width:auto" type="text" id="amount" />
                                <br />
                                <input type="checkbox" id="isManualEntry" /> Manual Entry<br />
                                <br />
                                <div id="manualEntryDiv" style="display: none">
                                    <table>
                                        <tr>
                                            <td>
                                                <label for="accountNumber">Card Number</label>
                                            </td>
                                            <td style="padding: 10px">
                                                <input class="form-control" style="width:auto" type="text" id="accountNumber" />
                                            </td>
                                            <td>
                                                <label for="expDate">Expiration</label>
                                            </td>
                                            <td style="padding: 10px">
                                                <input class="form-control" style="width:auto" type="text" id="expDate" />
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <label for="cvv">CVV</label>
                                            </td>
                                            <td style="padding: 10px">
                                                <input class="form-control" style="width:auto" type="text" id="cvv" />
                                            </td>
                                            <td>
                                                <label for="billingName">Billing Name</label>
                                            </td>
                                            <td style="padding: 10px">
                                                <input class="form-control" style="width:auto" type="text" id="billingName" />
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <label for="street">Street Address</label>
                                            </td>
                                            <td style="padding: 10px">
                                                <input class="form-control" style="width:auto" type="text" id="street" />
                                            </td>
                                            <td>
                                                <label for="zip">Zipcode</label>
                                            </td>
                                            <td style="padding: 10px">
                                                <input class="form-control" style="width:auto" type="text" id="zip" />
                                            </td>
                                        </tr>
                                    </table>
                                    <br />
                                </div>
                            </div>
                            <div id="Void" style="display: none">
                                <table>
                                    <tr>
                                        <td>
                                            <label for="uniqueTransId">UniqueTransID</label>
                                        </td>
                                        <td style="padding:10px">
                                            <input class="form-control" style="width: auto" type="text" id="uniqueTransId" />
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <div id="Echo" style="display: none">
                                <table>
                                    <tr>
                                        <td>
                                            <label for="message">Message</label>
                                        </td>
                                        <td style="padding:10px">
                                            <input class="form-control" style="width:auto" type="text" id="message" />
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <div id="RequestSignature" style="display: none">
                            </div>
                            <br />
                            <button type="button" class="btn btn-default" id="send">Send</button>
                        </form>
                    </div>
                </div>
                <div id="questionPanel" style="display: none">
                    <label id="question"></label>
                    <div>
                        <button class="btn btn-default" type="button" id="yes">Yes</button>
                        <button class="btn btn-default" type="button" id="no">No</button>
                    </div>
                </div>
                <br />
                <div class="panel panel-default" id="resultsPanel" style="display: none">
                    <div class="panel-heading">
                        <h3 class="panel-title">Results</h3>
                        <table>
                            <tr>
                                <td>
                                    <label for="resultStatus">Result Status</label>
                                </td>
                                <td style="padding: 10px">
                                    <input class="form-control" style="width:auto" type="text" id="resultStatus" />
                                </td>
                                <td>
                                    <label for="resultMessage">ResultMessage</label>
                                </td>
                                <td style="padding: 10px">
                                    <input class="form-control" style="width:auto" type="text" id="resultMessage" />
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <label for="amountProcessed">AmountProcessed</label>
                                </td>
                                <td style="padding: 10px">
                                    <input class="form-control" style="width:auto" type="text" id="amountProcessed" />
                                </td>
                                <td>
                                    <label for="uniqueTransIdResult">UniqueTransID</label>
                                </td>
                                <td style="padding: 10px">
                                    <input class="form-control" style="width:auto" type="text" id="uniqueTransIdResult" />
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <label for="signature">Signature</label>
                                </td>
                                <td style="padding: 10px">
                                    <input class="form-control" style="width:auto" type="text" id="signature" />
                                </td>
                                <td>
                                    <label for="resultBillingName">Billing Name</label>
                                </td>
                                <td style="padding: 10px">
                                    <input class="form-control" style="width:auto" type="text" id="resultBillingName" />
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
<script>

    function setFrom(control) {
        $("#to").val($(control).html());
        $("#message").focus();
    };

    $(function () {

        $("#connect").on('click', function () {

            var userName = $("#user-name").val();

            if (userName === '') return;

            //var connection = $.hubConnection('https://api-staging.chargeitpro.com');

            var connection = $.hubConnection('http://localhost:811');

            connection.qs = { "userName": userName };

            var remoteHub = connection.createHubProxy('ChatHub');

            remoteHub.on('send', function (from, message) {
                var result = JSON.parse(message);
                if (result.Action === 'Echo') {
                    alert("Message " + result.Data + " echoed from " + $("#to").val());
                    return;
                }
                else if (result.Action === 'Question') {
                    $("#questionPanel").show();
                    $("#question").text(result.Data);
                    return;
                }
                else if (result.Action === 'Result') {
                    if (result.ResultFields) {
                        $("#resultsPanel").show();
                        $("#resultStatus").val(result.Success);
                        if (result.ResultFields.ResultStatus)
                            $("#resultsPanel").css('border-color', "#4CA950");
                        else
                            $("#resultsPanel").css('border-color', "red");
                        $("#amountProcessed").val(result.ResultFields.AmountProcessed);
                        $("#resultMessage").val(result.ResultFields.ResultMessage);
                        $("#uniqueTransId").val(result.ResultFields.UniqueTransID);
                        $("#uniqueTransIdResult").val(result.ResultFields.UniqueTransID);
                        $("#signature").val(result.ResultFields.Signature);
                        $("#resultBillingName").val(result.ResultFields.BillingName);
                    } else {
                        alert("No Result returned from remote hardware.");
                    }
                    return;
                }
            });
           
            /* uncomment for verbose client side logging */
            //connection.logging = true;

            connection.start().done(function () {

                $("#send")
                    .off('click', function () { })
                    .on('click', function () {
                        $("#resultsPanel").hide();
                        var action = $("#transactionType option:selected").val();
                        if (action === "Echo") {
                            var eMessage = { Action: action, Data: $("#message").val() };
                            remoteHub.invoke('send', $("#to").val(), JSON.stringify(eMessage));
                            $("#message").val('');
                        }
                        else if (action === "CreditSale") {
                            clearResults();
                            var csMessage;
                            if ($("#isManualEntry").prop('checked'))
                                csMessage = { Action: "Transaction", Data: JSON.stringify({ TransactionType: action, Amount: $("#amount").val(), AccountNumber: $("#accountNumber").val(), BillingName:$("#billingName").val(), ExpDate: $("#expDate").val(), CVV: $("#cvv").val(), Street:$("#street").val(), Zip:$("#zip").val(), DeviceName: "S300NumberOne" }) };
                            else
                                csMessage = { Action: "Transaction", Data: JSON.stringify({ TransactionType: action, Amount: $("#amount").val(), DeviceName: "S300NumberOne" }) };
                            remoteHub.invoke('send', $("#to").val(), JSON.stringify(csMessage));
                            clearFields();
                        }
                        else if (action === "Void") {
                            var vMessage = { Action: "Transaction", Data: JSON.stringify({ TransactionType: action, UniqueTransRef: $("#uniqueTransId").val(), DeviceName:"S300NumberOne" }) };
                            remoteHub.invoke('send', $("#to").val(), JSON.stringify(vMessage));
                        }
                        else if (action === "RequestSignature") {
                            var rsMessage = { Action: "Transaction", Data: JSON.stringify({ TransactionType: action, DeviceName: "S300NumberOne" }) };
                            remoteHub.invoke('send', $("#to").val(), JSON.stringify(rsMessage));
                        }
                    });
                $("#yes")
                    .off('click', function() {})
                    .on('click', function() {
                        var yesMessage = { Action: "Answer", Success: true };
                        remoteHub.invoke('send', $("#to").val(), JSON.stringify(yesMessage));
                        $("#questionPanel").hide();
                    });
                $("#no")
                    .off('click', function() {})
                    .on('click', function() {
                        var noMessage = { Action: "Answer", Success: false };
                        remoteHub.invoke('send', $("#to").val(), JSON.stringify(noMessage));
                        $("#questionPanel").hide();
                    });


                $("#connected").html("You are connected as: " + userName).removeClass("error");

                //console.log(connection.id);

            }).fail(function (error) { console.log(error); });

            connection.error(function (error) {
                console.log('SignalR error: ' + error);
            });
        });

        $("#transactionType").on('change', function () {
            $("#CreditSale").hide();
            $("#Void").hide();
            $("#Echo").hide();
            $("#RequestSignature").hide();
            $("#" + $("#transactionType option:selected").val()).show();
        });

        $("#isManualEntry").on('change', function() {
            if (this.checked)
                $("#manualEntryDiv").show();
            else
                $("#manualEntryDiv").hide();
        });
    });

    function clearFields() {
        $("#amount").val('');
        $("#isManualEntry").prop('checked', false);
        $("#manualEntryDiv").hide();
        $("#accountNumber").val('');
        $("#uniqueTransId").val('');
        $("#uniqueTransIdResult").val('');
        $("#expDate").val('');
        $("#cvv").val('');
        $("#billingName").val('');
        $("#street").val('');
        $("#zip").val('');
    };

    function clearResults() {
        $("#resultsPanel").hide();
        $("#resultStatus").val('');
        $("#amountProcessed").val('');
        $("#resultMessage").val('');
        $("#uniqueTransId").val('');
        $("#uniqueTransIdResult").val('');
        $("#signature").val('');
        $("#resultBillingName").val('');
    };
</script>
